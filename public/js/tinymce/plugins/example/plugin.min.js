function loadFailure() {
    alert("Не удалось загрузить изображение");
    return true;
}
tinymce.PluginManager.add("example",function(a,b){

	a.addButton("example",{
		text:"",
		icon:"image",
		onclick:function(){
            var select = "center";
            var myImage = new Image();
            var param = 1;
            var img = a.selection.getNode();
            if (img.src){
                if ($(img).attr("style").indexOf("right") != -1){
                    select = "right";
                }
                if ($(img).attr("style").indexOf("left") != -1){
                    select = "left";
                }
            }
			a.windowManager.open(
                {
                    title:"Загрузка изображения",
                    bodyType: 'tabpanel',
                    body: [
                        {
                            title: 'General',
                            type: 'form',
                            items: [
                                {name: 'src', id:"uSrc", type: 'textbox', label: 'Источник'},
                                {name: 'alt', id:"uAlt", type: 'textbox', label: 'Описание изображения'},
                                {name: 'width', id:"uWidth", type: 'textbox', label: 'Ширина изображения'},
                                {name: 'height', id:"uHeight", type: 'textbox', label: 'Высота изображения'},
                                {name: 'align', id:"uAlign", value:select ,type: 'listbox', onselect : function(v) {
                                    select = v.control.value();
                                }, values:[{text: 'Left', value: 'left'},{text: 'Right', value: 'right'},{text: 'Center', value: 'center'}], label: 'Обтекание текстом'},
                                {type: 'label',
                                    name: 'someHelpText',
                                    multiline: true,
                                    style: 'height: 50px',
                                    text: "wedweded",
                                    onPostRender : function() {
                                        this.getEl().innerHTML ='Отступы <input type="text" id="uTop" style="width: 20px; left: 130px;" value="0"/><input type="text" id="uRight" style="width: 20px;left: 135px;" value="0"/><input id="uBottom" style="width: 20px;left: 140px;" type="text" value="0"/><input type="text" id="uLeft" style="width: 20px;left: 145px;" value="0"/>';
                                    }},
                                {name: 'file', id:"fileupload", type: 'textbox', subtype: 'file', label: 'Выберите файл', style: "height: 22px !important; background: transparent; padding: 3px;"},
                                {type: 'label',
                                    name: 'someHelpText',
                                    multiline: true,
                                    style: 'height: 50px',
                                    text: "",
                                    onPostRender : function() {
                                        this.getEl().innerHTML ='<div id="progress" style="padding: 0; border-radius: 5px; width: 100%;"><div class="progress-bar progress-bar-success" style="height: 3px; width: 0; background: rgb(68, 82, 149);"></div></div>';
                                    }}
                            ]
                        },
                    ],

                    width: 500,
                    height: 500,
                    inline: 1,
                    buttons: [{
                        text: 'Сохранить',
                        classes:'widget btn primary first abs-layout-item',
                        onclick: function(){
                            var style ="";
                            if (select == "right"){
                                style = "margin: "+$("#uTop").val()+"px "+$("#uRight").val()+"px "+$("#uBottom").val()+"px "+$("#uLeft").val()+"px; float: right;";
                            }
                            if (select == "left"){
                                style = "margin: "+$("#uTop").val()+"px "+$("#uRight").val()+"px "+$("#uBottom").val()+"px "+$("#uLeft").val()+"px; float: left;";
                            }
                            if (select == "center"){
                                style = "margin: "+$("#uTop").val()+"px auto "+$("#uBottom").val()+"px; display:block;";
                            }
                            style+=' width:'+$("#uWidth").val()+'px; height:'+$("#uHeight").val()+'px; ';


                            var image = '<img src="'+$("#uSrc").val()+'" style="'+style+'" alt="'+$("#uAlt").val()+'">';
                            top.tinymce.activeEditor.insertContent(image)//
                            a.windowManager.close()
                        }
                    },
                        {
                            text: 'Отмена',
                            onclick: 'close'
                        }]
                }, {
                    plugin_url: b
                })


            if (img.src){
                $("#uAlt").val(img.alt);
                $("#uSrc").val(img.src);
                $("#uWidth").val(parseInt($(img).width()));
                $("#uHeight").val(parseInt($(img).height()));
                $("#uTop").val(parseInt($(img).css("marginTop")));
                $("#uRight").val(parseInt($(img).css("marginRight")));
                $("#uBottom").val(parseInt($(img).css("marginBottom")));
                $("#uLeft").val(parseInt($(img).css("marginLeft")));
                param = parseInt($(img).width())/parseInt($(img).height());
            }
            else {
                var url = "/api/upload";
                $('#fileupload').fileupload({
                    url: url,
                    dataType: 'json',
                    done: function (e, data) {
                        $.each(data.result.files, function (index, file) {
                            function getWidthAndHeight() {
                                $("#uWidth").val(this.width);
                                $("#uHeight").val(this.height);
                                $("#uAlt").val(this.name);
                                param = this.width/this.height;
                                $("#uSrc").val(file.url);
                                return true;
                            }
                            myImage.name = "image.jpg";
                            myImage.onload = getWidthAndHeight;
                            myImage.onerror = loadFailure;
                            myImage.src = file.url;
                        });
                    },
                    progressall: function (e, data) {
                        var progress = parseInt(data.loaded / data.total * 100, 10);
                        $('#progress .progress-bar').css('width', progress + '%');
                    }
                }).prop('disabled', !$.support.fileInput)
                    .parent().addClass($.support.fileInput ? undefined : 'disabled');
            }
            $("#uWidth").on("input",function(){
                $("#uHeight").val(Math.ceil($("#uWidth").val()/param));
            });
            $("#uHeight").on("input",function(){
                $("#uWidth").val(Math.ceil($("#uHeight").val()*param));
            });
        }
    });
});
